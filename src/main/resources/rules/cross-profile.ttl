@prefix rdf:    <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix xs:     <http://www.w3.org/2001/XMLSchema#> .
@prefix sh:     <http://www.w3.org/ns/shacl#> .
@prefix rdfs:   <http://www.w3.org/2000/01/rdf-schema#> .
@prefix schema: <http://schema.org/> .
@prefix cim:    <http://iec.ch/TC57/2013/CIM-schema-cim16#> .

cim:ActivePowerPlanningValue_manual_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:ActivePowerPlanningValue ;
    sh:property    [ sh:path     cim:PlanningValue.powerSystemResource ;
                     sh:nodeKind sh:IRI ;
                     sh:message  "Planning values can only be connected to RedispatchableResources, ControllableResources, ControlGroups or Clusters" ;
                     sh:or       ( [ sh:class cim:RedispatchableResource ]
                                   [ sh:class cim:ControllableResource ]
                                   [ sh:class cim:Cluster ]
                                   [ sh:class cim:ControlGroup ] ) ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ] ;
    sh:sparql      [ sh:message "PlanningData for VERB, Vmin, Vmax needs to be smaller or equal to the sum of all netBottleneckPConsumption of connected storages" ;
                     sh:select  """
                PREFIX cim: <http://iec.ch/TC57/2013/CIM-schema-cim16#>
                SELECT $this ?verb (sum(?consumption) as ?value)
                WHERE {
                    VALUES ?kind { "VERB" "Vmax" "Vmin" }
                    $this cim:PlanningValue.kind ?kind ;
                                   cim:ActivePowerPlanningValue.value ?verb ;
                                   cim:PlanningValue.powerSystemResource/
                                   ^cim:Cluster.globalCluster*/
                                   cim:Cluster.controlGroup?/
                                   cim:Cluster.controllableResource?/
                                   ^cim:ControllableResource.controlGroup?/
                                   ^cim:RedispatchableResource.controllableResource?/
                                   cim:RedispatchableResource.storage ?storage .
                    ?storage       cim:Storage.netBottleneckPConsumption ?consumption .
                }
                GROUP BY $this ?verb
                HAVING (?verb > ?value)
              """ ] ;
    sh:sparql      [ sh:message "PlanningData for PROD, Pmin, Pmax needs to be smaller or equal to the sum of all netBottleneckPProduction of connected redispatchable resources" ;
                     sh:select  """
                PREFIX cim: <http://iec.ch/TC57/2013/CIM-schema-cim16#>
                SELECT $this ?prod (sum(?production) as ?value)
                WHERE {
                    VALUES ?kind { "Pmin" "Pmax" "PROD" }
                    $this          cim:PlanningValue.kind ?kind ;
                                   cim:ActivePowerPlanningValue.value ?prod ;
                                   cim:PlanningValue.powerSystemResource/
                                   ^cim:Cluster.globalCluster*/
                                   cim:Cluster.controlGroup?/
                                   cim:Cluster.controllableResource?/
                                   ^cim:ControllableResource.controlGroup?/
                                   ^cim:RedispatchableResource.controllableResource? ?tr .
                    ?tr       cim:RedispatchableResource.netBottleneckPProduction ?production .
                }
                GROUP BY $this ?prod
                HAVING (?prod > ?value)
              """ ] ;
    sh:sparql      [ sh:message "PlanningData for VERB, Vmin, Vmax can only be set for storages" ;
                     sh:select  """
                PREFIX cim: <http://iec.ch/TC57/2013/CIM-schema-cim16#>
                SELECT $this ?value
                WHERE {
                    VALUES ?kind { "VERB" "Vmax" "Vmin" }
                    $this cim:PlanningValue.kind ?kind ;
                                   cim:PlanningValue.powerSystemResource/
                                   ^cim:Cluster.globalCluster*/
                                   cim:Cluster.controlGroup?/
                                   cim:Cluster.controllableResource?/
                                   ^cim:ControllableResource.controlGroup?/
                                   ^cim:RedispatchableResource.controllableResource?/
                                   cim:RedispatchableResource.generatingUnit ?genUnit .
                    ?genUnit cim:IdentifiedObject.name ?value
                }
              """ ] .

cim:RedispatchableResourceContainsPlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:RedispatchableResource ;
    sh:property    [ sh:path     ( [ sh:zeroOrOnePath cim:RedispatchableResource.controllableResource ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controllableResource ] ]
                                   [ sh:zeroOrOnePath cim:ControllableResource.controlGroup ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controlGroup ] ]
                                   [ sh:zeroOrMorePath cim:Cluster.globalCluster ]
                                   [ sh:inversePath cim:PlanningValue.powerSystemResource ]
                                   cim:PlanningValue.kind ) ;
                     sh:hasValue "PROD" ;
                     sh:hasValue "+RDV" ;
                     sh:hasValue "-RDV" ;
                     sh:hasValue "Pmin" ;
                     sh:hasValue "Pmax" ;
                     sh:hasValue "-RDA" ;
                     sh:hasValue "+RDA" ] .

cim:StorageContainsPlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:Storage ;
    sh:property    [ sh:path     ( [ sh:inversePath cim:RedispatchableResource.storage ]
                                   [ sh:zeroOrOnePath cim:RedispatchableResource.controllableResource ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controllableResource ] ]
                                   [ sh:zeroOrOnePath cim:ControllableResource.controlGroup ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controlGroup ] ]
                                   [ sh:zeroOrMorePath cim:Cluster.globalCluster ]
                                   [ sh:inversePath cim:PlanningValue.powerSystemResource ]
                                   cim:PlanningValue.kind ) ;
                     sh:hasValue "VERB" ;
                     sh:hasValue "Vmin" ;
                     sh:hasValue "Vmax" ] .

cim:RedispatchableResourceSinglePlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:RedispatchableResource ;
    sh:sparql      [ sh:message "For every RedispatchableResource there should be only one instance of planning data for any kind" ;
                     sh:select  """
                        PREFIX cim: <http://iec.ch/TC57/2013/CIM-schema-cim16#>
                        SELECT $this ?kind (COUNT(?planningValue) as ?count) (GROUP_CONCAT(?planningValueName;SEPARATOR=", ") as ?value)
                        WHERE {
                            $this   cim:RedispatchableResource.controllableResource?/
                                    ^cim:Cluster.controllableResource?/
                                    cim:ControllableResource.controlGroup?/
                                    ^cim:Cluster.controlGroup/
                                    cim:Cluster.globalCluster*/
                                    ^cim:PlanningValue.powerSystemResource ?planningValue .
                                    ?planningValue cim:PlanningValue.kind ?kind ;
                                    cim:IdentifiedObject.name ?planningValueName .
                        }
                        GROUP BY ?kind $this
                        HAVING(?count > 1)
              """ ] .

cim:RedispatchableResourceExplicitOrImplicitPlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:RedispatchableResource ;
    sh:sparql      [ sh:message "All planning values should be attached to either the RedispatchableResource, ControllableResource, ControlGroup or Cluster, not multiple" ;
                     sh:select  """
                      PREFIX cim: <http://iec.ch/TC57/2013/CIM-schema-cim16#>
                      SELECT $this (COUNT(?base) as ?baseCounter) (GROUP_CONCAT(?base;SEPARATOR=", ") as ?bases) WHERE {
                        SELECT $this ?base
                        WHERE {
                            $this   a cim:RedispatchableResource ;
                                    cim:RedispatchableResource.controllableResource?/
                                    ^cim:Cluster.controllableResource?/
                                    cim:ControllableResource.controlGroup?/
                                    ^cim:Cluster.controlGroup?/
                                    cim:Cluster.globalCluster* ?base .
                            ?base   ^cim:PlanningValue.powerSystemResource ?planningValue .
                        }
                        GROUP BY $this ?base
                    }
                    GROUP BY $this
                    HAVING(?baseCounter > 1)
                    """ ] .

cim:WindGeneratingUnitContainsPlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:WindGeneratingUnit ;
    sh:property    [ sh:path     ( [ sh:inversePath cim:RedispatchableResource.generatingUnit ]
                                   [ sh:zeroOrOnePath cim:RedispatchableResource.controllableResource ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controllableResource ] ]
                                   [ sh:zeroOrOnePath cim:ControllableResource.controlGroup ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controlGroup ] ]
                                   [ sh:zeroOrMorePath cim:Cluster.globalCluster ]
                                   [ sh:inversePath cim:PlanningValue.powerSystemResource ]
                                   cim:PlanningValue.kind ) ;
                     sh:hasValue "Pdar (Wind)" ] .

cim:SolarGeneratingUnitContainsPlanningData_Shape
    a              sh:NodeShape ;
    sh:closed      false ;
    sh:targetClass cim:SolarGeneratingUnit ;
    sh:property    [ sh:path     ( [ sh:inversePath cim:RedispatchableResource.generatingUnit ]
                                   [ sh:zeroOrOnePath cim:RedispatchableResource.controllableResource ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controllableResource ] ]
                                   [ sh:zeroOrOnePath cim:ControllableResource.controlGroup ]
                                   [ sh:zeroOrOnePath [ sh:inversePath cim:Cluster.controlGroup ] ]
                                   [ sh:zeroOrMorePath cim:Cluster.globalCluster ]
                                   [ sh:inversePath cim:PlanningValue.powerSystemResource ]
                                   cim:PlanningValue.kind ) ;
                     sh:hasValue "Pdar (Solar)" ] .